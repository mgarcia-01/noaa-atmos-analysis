---
title: "Research Analysis for NOAA Weather"
output:
  html_notebook: default
  html_document: default
  md_document:
    variant: markdown_github
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Storm Research Analysis {.tabset .tabset-fade .tabset-pills}

### Main Report Section

##### Synopsis Revised

This report utilizes NOAA storm weather data to explain weather patterns. The weather in research are disastrous conditions, and the attributes of the weather. The analysis will also deliver results on the events that directly may have resulted from the unusual weather. The analysis reveals that the most frequent events are not necessarily the most damaging. Events that are most economically costly, are not the events that cause the most damage to population health. 

Tornadoe, Heat, and Flash Floods are the top  3 causes of most fatalities. Hail, thunderstorms windws and tornadoes are the top 3 most frequent. Flood, Hurricane, and tornadoes are the top 3 most costly events.

##### Data Processing

The data was fetched from NOAA (see Citation for url). The source to pull process and retain the data can be see in the code below. The code for data tables and graphcs is provided within the R Chunks. There are a few values within my statements that are inline R chunks. The RMD file will show which sentences  use inline calculations.

```{r Data Processing, include=TRUE, echo=TRUE}
### Week 1 Project ###
#library(data.table)
webURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
destURL <- file.path(getwd(),paste("repdata_data_StormData.csv",".bz2",sep = ""))
download.file(webURL,destfile = destURL)

#unzip(destURL)
#localFileURL <- file.path(getwd(),paste("repdata_data_StormData",".csv",sep = ""))
repdata <- read.csv(destURL)
```

##### Summary

Summary of Each Variable.

```{r summary, include = TRUE, echo=FALSE}
#as.table(summary(repdata))

## rmarkdown::paged_table()
```

##### Events most harmful to population health

```{r event types,include =  TRUE, echo = TRUE}
eventFreq <- aggregate(repdata$EVTYPE, list(repdata$EVTYPE), length)
names(eventFreq) <- c("EVTYPE","Qty")
eventFatal <- aggregate(repdata$FATALITIES, list(repdata$EVTYPE), sum)
names(eventFatal) <- c("EVTYPE","FATALITIES")
eventsInjur <- aggregate(repdata$INJURIES, list(repdata$EVTYPE), sum)
names(eventsInjur) <- c("EVTYPE","INJURIES")
#a <- eventFreq[order(eventFreq$Qty, decreasing = TRUE),]
eventDamag <- merge(eventFreq,eventFatal, by.x = "EVTYPE", all = TRUE)
eventDamag <- merge(eventDamag, eventsInjur, by.x = "EVTYPE", all = TRUE)
eventDamag <- eventDamag[order(eventDamag$"Qty", decreasing = TRUE),]
eventDamag
#plot(eventFreq$EVTYPE,eventFreq$Qty,type ="h")
```
This table shows the event types ordered by frequency. This depicts that the most frequent types `r eventDamag[1,1]` at `r eventDamag[1,2]` and `r eventDamag[nrow(eventDamag),1]` at `r eventDamag[nrow(eventDamag),2]` are not the most frequent  

```{r injury_fatalities, include= TRUE,echo= TRUE}
ftl <- eventDamag[order(eventDamag$FATALITIES, decreasing = TRUE),]
ftl

```
`r ftl[1,1]` event is the top event causing fatalities at `r ftl[1,3]` fatalities. `r ftl[nrow(ftl),1]` is the event with the least number of fatalities at `r ftl[nrow(ftl),3]`

```{r ftl_plot, include=FALSE, echo=FALSE}
tftl <- head(ftl[order(ftl$FATALITIES, decreasing = TRUE),],10)
tftl$FATALITIES <- as.numeric(tftl$FATALITIES)
tftl$EVTYPE <- factor(tftl$EVTYPE)
#plot(pl$EVTYPE,(pl$TOTLDMG/1000), type = "h", xlab = "EVTYPE", ylab = "Total Damage Amount")

library(ggplot2)
ggplot(tftl, aes(x=reorder(EVTYPE, -FATALITIES), y=format(FATALITIES, scientific = FALSE), group=1)) + geom_bar(stat = "identity", fill = "#0099FF")+ 
            theme(axis.text.x = element_text(angle = 45, hjust = 1)
                               ,axis.title.x = element_text(face="bold", size=12)
                               ,legend.position="none")+
                                    labs(x="Event Type",y="FATALITIES") 
```

 
```{r include= FALSE, echo=FALSE}
###  This bar graph displays the top 10 events that cause the most fatalities.
```

```{r damageqty, include = TRUE, echo = TRUE}
dm <- head(eventDamag[order(eventDamag$Qty, decreasing = TRUE),],10)
dm$Qty <- as.numeric(dm$Qty)
dm$EVTYPE <- factor(dm$EVTYPE)
#plot(pl$EVTYPE,(pl$TOTLDMG/1000), type = "h", xlab = "EVTYPE", ylab = "Total Damage Amount")

library(ggplot2)
g1 <- ggplot(dm, aes(x=reorder(EVTYPE, -Qty), y=format(Qty, scientific = FALSE), group=1)) + geom_bar(stat = "identity", fill = "#0099FF")+ 
            theme(axis.text.x = element_text(angle = 45, hjust = 1)
                               ,axis.title.x = element_text(face="bold", size=12)
                               ,legend.position="none")+
                                    labs(x="Event Type",y="Event Frequency") 
```
This table displayes the top ten events that are most frequent. `r head(dm$EVTYPE,1)` is the event that occurs the most at `r format(head(dm$Qty,1), scientific = FALSE)` number of events. `r dm[10,1]` is the least top frequent occuring event coming at `r format(dm[10,2], scientific = FALSE)` number of events.



#####  Events have the greatest economic consequences


```{r event histogram,include =  TRUE, echo = TRUE}
#a <- head(eventDamag[order(eventDamag$"Qty", decreasing = TRUE),],5)
#plot(a$EVTYPE, as.numeric(a$Qty/1000), type = "h")
#   “K” for thousands, “M” for millions, and “B” for billions
#PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
      # totaldmg doesnt work since the exp is different for prop and crop
##totalDmg <- aggregate((repdata$PROPDMG+repdata$CROPDMG), list(repdata$EVTYPE,repdata$PROPDMGEXP), sum)
##colnames(totalDmg) <- c("EVTYPE","TOTALEXP","TOTALDMG")
# This chunk transforms the damage values into 
bil <- 1000000000
mil <- 1000000
thous <- 1000

repDataConv <- repdata
propDmg <- aggregate((ifelse(repdata$PROPDMGEXP == "B",repdata$PROPDMG*bil
                             ,ifelse(repdata$PROPDMGEXP == "M",repdata$PROPDMG*mil
                                     , ifelse(repdata$PROPDMGEXP == "K"
                                              ,repdata$PROPDMG*thous
                                              ,0
                                              )
                                     )
                          )
                      )
                             , list(repdata$EVTYPE
                                    #,repdata$PROPDMGEXP
                                    ), sum)
#colnames(propDmg) <- c("EVTYPE","EXP","PROPDMG")
colnames(propDmg) <- c("EVTYPE","PROPDMG")

cropDmg <- aggregate((ifelse(repdata$CROPDMGEXP == "B",repdata$CROPDMG*bil
                             ,ifelse(repdata$CROPDMGEXP == "M",repdata$CROPDMG*mil
                                     , ifelse(repdata$CROPDMGEXP == "K",repdata$CROPDMG*thous
                                              ,0
                                              )
                                     )
                          )
                      ), list(repdata$EVTYPE
                              #,repdata$CROPDMGEXP
                              ), sum)
#colnames(cropDmg) <- c("EVTYPE","EXP","CROPDMG")
colnames(cropDmg) <- c("EVTYPE","CROPDMG")

eventDamagProp <- merge(eventDamag, propDmg,by.x = "EVTYPE", all = TRUE)
eventDmgPrp <- merge(eventDamagProp, cropDmg,by.x = "EVTYPE", all = FALSE)
                                                  #c("EVTYPE","EXP")
eventDmgPrp$TOTLDMG <- (eventDmgPrp$PROPDMG + eventDmgPrp$CROPDMG)

# this is the Millions
 #a <- eventDmgPrp[which(eventDmgPrp$EXP == "B"),]
# head(a[order(a$TOTLDMG, decreasing = TRUE),],10)
 #head(eventDmgPrp[order(eventDmgPrp$TOTLDMG, decreasing = TRUE),],10)
eventDmgPrp$PROPDMG <- round(eventDmgPrp$PROPDMG/1000,1)
eventDmgPrp$CROPDMG <- round(eventDmgPrp$CROPDMG/1000,1)
eventDmgPrp$TOTLDMG <- round(eventDmgPrp$TOTLDMG/1000,1)
eventDmgPrp[order(eventDmgPrp$TOTLDMG, decreasing = TRUE),]
```
This table is sorted by the total property damage cost from most to least and represented in thousands ('000). The values were converted to full dollar amount based on the EXP value.



```{r damageplot, include= TRUE, echo = TRUE}
pl <- head(eventDmgPrp[order(eventDmgPrp$TOTLDMG, decreasing = TRUE),],10)
pl$TOTLDMG <- as.numeric(pl$TOTLDMG)
pl$EVTYPE <- factor(pl$EVTYPE)
#plot(pl$EVTYPE,(pl$TOTLDMG/1000), type = "h", xlab = "EVTYPE", ylab = "Total Damage Amount")

library(ggplot2)
g2 <- ggplot(pl, aes(x=reorder(EVTYPE, -TOTLDMG), y=format(TOTLDMG, scientific = FALSE), group=1)) + geom_bar(stat = "identity", fill = "#0099FF")+ 
            theme(axis.text.x = element_text(angle = 45, hjust = 1)
                               ,axis.title.x = element_text(face="bold", size=12)
                               ,legend.position="none")+
                                    labs(x="Event Type",y="Damage Amount (000's)") 
                                    
# plot(activityWkend$interval, activityWkend$avgSteps, type = "l",xlab = "interval", ylab = "WkEnd Avg Steps")
```
This chart shows the top 10 most economically damaging events, from most to least. The Flood is the most costly and the Ice Storm is the least.

```{r timeseries, include= TRUE, echo= TRUE}

tmEvent <- repdata[which(is.na(repdata$BGN_DATE) == FALSE),]
tmEvent$BGN_DATE <-  as.Date(tmEvent$BGN_DATE, format = "%m/%d/%Y")

tmEventAg <- aggregate(tmEvent$FATALITIES, list(tmEvent$BGN_DATE), sum, na.rm = TRUE)      # repdata$BGN_DATE
colnames(tmEventAg) <- c("BGN_DATE","FATALITIES")
tmEventMean <- aggregate(tmEvent$FATALITIES, list(tmEvent$BGN_DATE), mean, na.rm = TRUE)      # repdata$BGN_DATE
colnames(tmEventAg) <- c("BGN_DATE","FATALITIES")
# tmEventAg <- tmEventAg[which(tmEventAg$BGN_DATE >= "1990-01-01"),]
tmEventInj <- aggregate(tmEvent$INJURIES, list(tmEvent$BGN_DATE), sum, na.rm = TRUE) 
colnames(tmEventInj) <- c("BGN_DATE","INJURIES")

#plot(tmEventAg$BGN_DATE,  (tmEventAg$FATALITIES), type = "h", xlab = "Event Date", ylab = "Fatalities")
tmEventFtlInj <- merge(tmEventAg,tmEventInj, by = "BGN_DATE")
#plot(tmEventFtlInj$BGN_DATE, log(tmEventFtlInj$INJURIES), col = "green", type = "p",pch = 20
#     , xlab = "Event Date", ylab = "Qty of People")
#lines(tmEventFtlInj$BGN_DATE,log(tmEventFtlInj$FATALITIES), col = "red",type = "p")
  dev.new(width=10, height=10)
  par(mfrow=c(2,2))
  #par(mfcol=c(2,1))
  plot(tmEventAg$BGN_DATE[order(tmEventAg$BGN_DATE)],  log(tmEventAg$FATALITIES), type = "p", col = "dodger blue",pch = 20 ,xlab = "Event Date", ylab = "Fatalities")
   plot(tmEventAg$BGN_DATE[order(tmEventAg$BGN_DATE)], log(tmEventFtlInj$INJURIES), col = "green", type = "l",pch = 20
       , xlab = "Event Date", ylab = "Qty of People")
      lines(tmEventAg$BGN_DATE[order(tmEventAg$BGN_DATE)],log(tmEventFtlInj$FATALITIES), col = "red",type = "p", pch = 20)
  plot(tmEventAg$BGN_DATE[order(tmEventAg$BGN_DATE)],  (tmEventInj$INJURIES), type = "p", col = "dodger blue",pch = 20, xlab = "Event Date", ylab = "Injuries")
mtext("Fatalities and Injuries", side=3, outer=TRUE, line=-1, col = "blue") 
#dev.off()

tmEventFtlInj[order(tmEventFtlInj$BGN_DATE, decreasing = TRUE),]
```


```{r echo=TRUE}
BGN_DATEP <- as.POSIXct(unlist(tmEventFtlInj$BGN_DATE), tz = "GMT")
BGN_MONTH <- strftime(BGN_DATEP, "%m")
BGN_YEAR <- strftime(BGN_DATEP, "%Y")
BGN_DATES <- data.frame(BGN_MONTH,BGN_YEAR,BGN_DATEP)
tmeventSeries <- cbind(BGN_DATES ,tmEventFtlInj)

tmSeriesAgF <- aggregate(FATALITIES~ BGN_MONTH+ BGN_YEAR, tmeventSeries, FUN = sum)
tmSeriesAgI <- aggregate(INJURIES~ BGN_MONTH+ BGN_YEAR, tmeventSeries, FUN = sum)
tmSeriesAg <- merge(tmSeriesAgF,tmSeriesAgI, by = c("BGN_MONTH", "BGN_YEAR"))
tmSeriesAg$MOYR <- as.POSIXct(paste(tmSeriesAg$BGN_YEAR, tmSeriesAg$BGN_MONTH, "01", sep = "-"))
plot(tmSeriesAg$MOYR[order(tmSeriesAg$MOYR)], tmSeriesAg$INJURIES, col = "green", type = "l",pch = 20
       , xlab = "Event Date", ylab = "Qty of People")
 lines(tmSeriesAg$MOYR[order(tmSeriesAg$MOYR)],tmSeriesAg$FATALITIES, col = "red",type = "l", pch = 20)
 
 par(mfrow=c(2,1), mai = c(.5, .5, 0.2, 0.1))
 plot(tmSeriesAg$MOYR[order(tmSeriesAg$MOYR)], tmSeriesAg$INJURIES, col = "green", type = "l",pch = 20
       , xlab = "Event Date", ylab = "Qty of People")
 plot(tmSeriesAg$MOYR[order(tmSeriesAg$MOYR)], tmSeriesAg$FATALITIES, col = "dodger blue", type = "l",pch = 20
       , xlab = "Event Date", ylab = "Qty of People")
 mtext("Fatalities and Injuries", side=3, outer=TRUE, line=-1, col = "blue") 

```


### Source Citation and Resource:
    NATIONAL WEATHER SERVICE INSTRUCTION  10-1605 
    AUGUST 17, 2007 
    Operations and Services 
    Performance, NWSPD 10-16
    STORM DATA PREPARATION


    Storm Data Documentation: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf
    FAQ: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf
    

    
### License and Copyright Notice
    Self published Research Analysis for NOAA Weather
    Copyright © 2017 Michael Garcia. All Rights Reserved.
    Inquiries: mgar_datascience@protonmail.com
    
    This program is distributed  WITHOUT ANY WARRANTY; without even the 
    implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR 
    PURPOSE.  
##
